#! /bin/sh

usage() {
    echo "usage: rock-make-doc target_dir [main_doc_template] [directory_template]"
    echo "you must run it from within the autoproj installation that you want"
    echo "to generate the documentation for"
    exit 1
}

is_absolute() {
    case $1 in
        /*) return 0 ;;
        *) return 1 ;;
    esac
}

autoproj_dir=$PWD
target_dir=$1
main_template_dir=$2
directory_template_dir=$3

if test -z $main_template_dir; then
    main_template_dir=git://gitorious.org/rock/doc.git
fi

if ! test -d "$autoproj_dir/autoproj"; then
    echo "$autoproj_dir is not an autoproj installation"
    echo
    usage
fi

if test -z "$target_dir"; then
    echo "no target dir given"
    echo
    usage
fi

if ! is_absolute "$target_dir"; then
    echo "$target_dir must be an absolute path"
    exit 1
fi

if test -d "$target_dir"; then
    echo "$target_dir already exists"
    exit 1
fi

set -e

tempdir=$(mktemp -d)
echo "generating the API documentation from the autoproj packages"
cd $autoproj_dir
autoproj doc
mkdir -p $target_dir
echo "moving API documentation to $target_dir/api"
mv install/doc $target_dir/api

autoproj_version=`$GEM_HOME/bin/autoproj --version | sed 's/autoproj.*v//'`
autoproj_api_dir=$GEM_HOME/doc/autoproj-$autoproj_version
if test -d $autoproj_api_dir; then
    echo "copying autoproj API documentation to $target_dir/api/autoproj"
    cp -r $autoproj_api_dir/rdoc $target_dir/api/autoproj
else
    echo "could not find the autoproj API in $autoproj_api_dir"
fi

autobuild_version=`$GEM_HOME/bin/autobuild --version | sed 's/autobuild.*v//'`
autobuild_api_dir=$GEM_HOME/doc/autobuild-$autobuild_version
if test -d $autobuild_api_dir; then
    echo "copying autobuild API documentation to $target_dir/api/autobuild"
    cp -r $autobuild_api_dir/rdoc $target_dir/api/autobuild
else
    echo "could not find the autobuild API in $autobuild_api_dir"
fi

echo "creating rock's main documentation"
cd $tempdir
git clone $main_template_dir main
cd main
rake
echo "moving main documentation in $target_dir"
mv out/* $target_dir

cd $autoproj_dir
rock-directory "$target_dir/package_directory" $directory_template_dir

echo "deleting $tempdir"
rm -rf $tempdir

