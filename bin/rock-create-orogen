#! /bin/sh

name=$1
if test -z "$name"; then
    echo "usage: rock-create-orogen dirname"
    exit 1
fi
if test -e "$name"; then
    echo "$name already exists"
    exit 1
fi

# Test if name is a valid orogen component name
CMP_NAME_BASE=`echo "$name" | sed 's/.*\/\(.*\)/\1/g'`
CMP_NAME=`echo "$CMP_NAME_BASE" | grep -e '^[a-z0-9][a-z0-9_]*$'`

if test -z "$CMP_NAME"; then
    echo 
    echo "Invalid name ${CMP_NAME_BASE}: The component name must be all lowercase, can contain alphanumeric characters and underscores and start with a letter."
    echo 
    exit 1
fi

orogen create $name
cd $name
if test -z "$ROCK_TEMPLATE_PREFIX"; then
    ROCK_TEMPLATE_PREFIX=git://gitorious.org/rock-base/template_
    ROCK_TEMPLATE_SUFFIX=.git
    wget --timeout=5 http://gitorious.org/rock-base/template_cmake_lib/blobs/raw/master/manifest.xml

    if [ $? != 0 ]; then
	echo
	echo "ROCK_TEMPLATE_PREFIX is not set and manifest can currently not be retrieved via gitorious.org"
	echo "Verify your internet connnection or set ROCK_TEMPLATE_PREFIX to <your-rock-installation>/base/templates/"
	echo
	exit 2
    fi

    echo
    echo "Please fill out $name/manifest.xml "
    echo
    echo "This is needed for autoproj to keep track of the dependencies and"
    echo "to tell other people what the orogen package is about."
    echo

else
    CMAKE_LIB_DIR=`echo "${ROCK_TEMPLATE_PREFIX}/cmake_lib" | sed 's/\/\//\//g'`
    if ! test -d "$CMAKE_LIB_DIR"; then
	echo
	echo "Package base/templates/cmake_lib is required, but could not be found at ${CMAKE_LIB_DIR}."
	echo "Please make sure you install package base/templates/cmake_lib."
	echo
	exit 3
    fi
	
    cp $CMAKE_LIB_DIR/manifest.xml .
    sh $CMAKE_LIB_DIR/config_manifest.sh
fi

