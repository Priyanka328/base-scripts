#! /usr/bin/env ruby

base_dir = File.expand_path('../lib', File.dirname(__FILE__))
$LOAD_PATH.unshift base_dir

require 'autoproj'
require 'autoproj/cmdline'
require 'rock/autoproj_webgen'
require 'rock/orogen_webgen'

output_dir = ARGV.shift
if !output_dir
    STDERR.puts "usage: rock-directory-pages output_dir"
    exit(1)
end

Autoproj::CmdLine.initialize_and_load
manifest = Autoproj.manifest

api_dir = ARGV.shift

root_metainfo = []
sort_order = 0

render = Rock::Doc::Render.new(output_dir)

class Package
    # The Autobuild::Package instance that describes this package
    attr_reader :pkg

    # The PackageSet instance which defines this package
    attr_reader :pkg_set

    # If true, this package has some HTML documentation generated in
    # API_ROOT/package_name/index.html
    attr_predicate :has_api?

    # If this package is an orogen package, this is the name of the orogen
    # project
    attr_reader :orogen_name

    def name
        pkg.name
    end

    def initialize(pkg, pkg_set, has_api, orogen_name)
        @pkg, @pkg_set, @has_api, @orogen_name =
            pkg, pkg_set, has_api, orogen_name
    end
end

all_packages = Hash.new
manifest.each_package_set.to_a.sort_by(&:name).each do |pkg_set|
    next if pkg_set.local?

    if metainfo = render.package_set(pkg_set, (sort_order += 1))
        root_metainfo << metainfo
    end

    pkg_set.each_package.each do |pkg|
        all_packages[pkg.name] = [pkg, pkg_set.name]
    end
end

all_packages = all_packages.each_value.map do |pkg, pkg_set|
    if !File.directory?(pkg.srcdir)
        Autoproj.warn "#{pkg.srcdir} does not exist, skipping #{pkg.name}"
        next
    end

    if File.exists?(File.join(pkg.srcdir, "manifest.xml"))
        manifest.load_package_manifest(pkg.name)
        manifest.resolve_optional_dependencies
    end

    if pkg.kind_of?(Autobuild::Orogen)
        orogen_file = File.join(pkg.srcdir, pkg.orogen_file)
        orogen_name = File.readlines(orogen_file).grep(/^name\s/).to_a.first
        if orogen_name
            orogen_name =~ /^name[^\w]+(\w+)/
            orogen_name = $1
            Rock::Doc.orogen_to_autoproj[orogen_name] = pkg.name
        else
            STDERR.puts "WARN: cannot extract the oroGen project name from #{orogen_file} (package: #{pkg.name})"
        end
    end

    if api_dir && File.directory?(File.join(api_dir, pkg.name))
        has_api = true
    end

    Package.new(pkg, pkg_set, has_api, orogen_name)
end

Rock::Doc.api_dir = api_dir
Rock::Doc.link_api_dir = "/api/"
Rock::Doc.autoproj_packages = all_packages

all_packages.sort_by(&:name).each do |pkg|
    if metainfo = render.package(pkg, (sort_order += 1))
        root_metainfo << metainfo
    end
end

Autoproj.osdeps.all_definitions.sort_by(&:first).each do |name, data|
    if metainfo = render.osdeps(name, data, (sort_order += 1))
        root_metainfo << metainfo
    end
end

Rock::Doc::OrogenRender.render_all(output_dir, true)

metainfo = root_metainfo.map do |dir, title, sort|
        ["#{dir}:",
         "  title: #{title}",
         "  routed_title: #{title}",
         "  sort_info: #{sort}",
         ""].join("\n")
    end.join("\n")

Rock::Doc.render_page(File.join(output_dir, 'htmldoc.metainfo'), metainfo)

